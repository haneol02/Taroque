import OpenAI from 'openai';
import { CardSelection } from '@/types/tarot';

export const createOpenAIClient = (apiKey: string) => {
  return new OpenAI({
    apiKey: apiKey,
  });
};

export const analyzeQuestionPrompt = (userQuestion: string) => `
사용자의 고민을 분석하여 가장 적합한 타로 카드 수를 결정해주세요.

사용자 질문: "${userQuestion}"

카드 수 결정 기준:
- 1카드: 단순한 오늘/내일 운세, Yes/No 질문
- 3카드: 일반적인 고민, 과거-현재-미래 분석이 필요한 경우
- 5카드: 복잡한 상황, 다각도 분석이 필요한 경우  
- 7카드: 매우 복합적인 문제, 장기적 관점이 필요한 경우

응답은 반드시 다음 JSON 형식으로만 답해주세요:
{
  "cardCount": 3,
  "reason": "현재 연애 상황과 앞으로의 방향성을 보기 위해 과거-현재-미래 구조가 적합합니다",
  "positions": ["과거의 영향", "현재 상황", "미래 전망"]
}
`;

export const interpretCardsPrompt = (question: string, selectedCards: CardSelection[]) => `
당신은 30년 경력의 전문 타로 리더입니다. 사용자의 질문을 중심으로 카드들을 해석하며, 질문의 맥락에 맞는 구체적이고 실용적인 답변을 제공합니다.

사용자 질문: "${question}"

선택된 카드와 상세 정보:
${selectedCards.map((card, idx) =>
  `${idx + 1}. ${card.position}: ${card.cardName} ${card.isReversed ? '(역방향)' : '(정방향)'}
     키워드: ${card.keywords?.join(', ') || ''}
     의미: ${card.meaning || ''}`
).join('\n\n')}

해석 가이드라인:
1. 질문의 핵심 키워드와 의도를 파악하여 카드 해석에 반영
2. 질문자의 상황과 고민에 직접적으로 연결되는 메시지 전달
3. 추상적 표현보다는 구체적이고 이해하기 쉬운 언어 사용
4. 질문 맥락에서 각 카드가 주는 실질적 조언 제시
5. 일반적인 카드 의미가 아닌, 이 질문에 특화된 해석 제공

필수 해석 구조 (마크다운 형식):
## "${question}"에 대한 타로의 답변
(질문에 대한 핵심 답변을 3-4문장으로 명확하게 제시. 질문의 주요 키워드를 포함하여 직접적으로 답변)

## 현재 상황과 에너지 흐름
(선택된 카드들이 보여주는 현재 상황과 에너지의 변화 과정을 질문 맥락에서 해석 4-5문장)

## 카드별 구체적 메시지
${selectedCards.map((card) =>
  `### ${card.position}: ${card.cardName} ${card.isReversed ? '(역방향)' : '(정방향)'}
"${question}"의 관점에서 이 카드는 [구체적인 상황이나 감정을 질문과 연결하여 설명]. [이 포지션에서 질문자가 알아야 할 핵심 메시지를 3-4문장으로 쉽게 설명]`
).join('\n\n')}

## 카드들이 말하는 전체 스토리
(모든 카드를 연결하여 질문 상황의 과거-현재-미래 또는 원인-현상-결과의 스토리를 질문 맥락에서 설명 4-5문장)

## 질문 해결을 위한 실천 방안
• **즉시 실행할 것**: [질문 해결에 직접 도움이 되는 구체적 행동]
• **주의깊게 관찰할 것**: [질문 상황에서 놓치기 쉬운 중요한 신호나 변화]
• **피해야 할 것**: [질문 상황을 악화시킬 수 있는 행동이나 태도]
• **장기적으로 준비할 것**: [질문의 근본적 해결을 위한 장기 계획]

## 타로가 제시하는 전망
**가능성 높은 시나리오**: [질문 상황의 가장 현실적인 전개 방향]
**주의할 시나리오**: [경계해야 할 상황과 대비책]
**최적의 결과를 위한 조건**: [원하는 결과를 얻기 위해 필요한 것들]

## 마무리 조언
(질문자의 고민에 대한 따뜻하면서도 현실적인 격려와 조언을 2-3문장으로 마무리)

작성 시 중요사항:
- 질문의 핵심 단어들을 해석 전반에 자연스럽게 포함
- "일반적으로", "보통" 같은 추상적 표현 대신 "당신의 상황에서는" 등 구체적 표현 사용  
- 카드 의미를 질문 상황에 직접 적용하여 개인화된 해석 제공
- 이해하기 쉬운 일상 언어로 작성하되 전문성 유지
- 실행 가능한 구체적 조언과 명확한 방향성 제시
- 총 1200-1600자 내외의 충실한 해석

답변은 한국어로 작성해주세요.
`;